# SVG2PNG 実装計画と進捗状況

## プロジェクト概要

Pure Goで実装されたSVGからPNGへの変換ライブラリ。特にテキスト描画に特化し、システムフォントの自動検出と高品質なレンダリングを提供することを目標としています。

## 実装計画（2スプリント）

### Sprint 1（M0-M2）: 基本機能

#### M0: パーサーと図形描画 ✅
- [x] SVGパーサーの基本実装
- [x] 基本的な図形要素（`<rect>`, `<circle>`）の描画
- [x] 塗りと線の基本対応
- [x] PNG出力機能

#### M1: フォントシステムとテキスト描画 ✅
- [x] フォントマネージャーの基本構造
- [x] システムフォントスキャンの枠組み
- [x] `golang.org/x/image/font/sfnt`によるフォント読み込み
- [x] 基本的なテキスト要素の描画
- [x] フォントスタイル（Bold、Italic）の対応
- [x] `text-anchor`属性の対応

#### M2: 高度な機能 🔄
- [x] 不透明度（要素/塗り/線）の基本対応
- [x] `viewBox`の基本対応
- [x] `%→px`変換の基本実装
- [x] 基本的な変形（transform）対応
- [x] 継承システムの基本実装

### Sprint 2（M3-M5）: 最適化と品質向上

#### M3: テキスト機能の拡充 🔄
- [x] 基本的なテキスト描画
- [ ] `<tspan>`の同一行スタイル/座標
- [ ] `dx/dy`の精度向上
- [ ] 継承システムの完全実装

#### M4: パフォーマンス最適化
- [ ] パスフラット化のキャッシュ
- [ ] glyph atlasの実装
- [ ] 描画の並列化
- [ ] メモリ使用量の最適化

#### M5: 品質向上とAPI凍結
- [ ] 診断システムの強化
- [ ] エラー型の整理
- [ ] APIの最終調整
- [ ] 包括的なテストスイート

## 現在の実装状況

### ✅ 完了済み

1. **プロジェクト構造**
   - モジュール初期化
   - パッケージ分割（parser, renderer, font, style, viewport, raster）
   - コマンドラインインターフェース

2. **SVGパーサー**
   - 基本的なXML解析
   - viewBox属性の解析
   - 要素の階層構造の保持

3. **ビューポート解決**
   - 次元値の解析（px、%）
   - viewBoxからビューポートへの変換

4. **スタイル解決**
   - プレゼンテーション属性の解析
   - 色値の解析（名前付き色、16進数）
   - 基本的な継承システム

5. **ラスタリング**
   - フレームバッファの実装
   - 基本的な図形描画（矩形、円）
   - アルファブレンディング

6. **フォントシステム** ✅ **新規完了**
   - フォントマネージャーの基本構造
   - プラットフォーム別フォントパス検出
   - フォント登録API
   - **SFNTフォントの読み込みと解析**
   - **基本的なテキストレンダリング**
   - **フォントスタイルの対応**
   - **システムフォントの自動スキャン**

7. **テキスト描画** ✅ **新規完了**
   - 基本的なテキスト要素の描画
   - フォントファミリとスタイルの対応
   - `text-anchor`属性の実装
   - フォントサイズの調整
   - 基本的なグリフレンダリング

### 🔄 進行中

1. **テキスト描画の高度化**
   - `<tspan>`要素の対応
   - より精密なフォントメトリクス
   - アンチエイリアシングの改善

2. **パス描画**
   - SVGパスの詳細解析
   - ベジェ曲線の描画

### ❌ 未実装

1. **高度なSVG機能**
   - 複雑なパスの描画
   - グラデーション・パターン
   - フィルタ・マスク

2. **パフォーマンス最適化**
   - 並列処理
   - キャッシュシステム

## 技術的な課題と解決策

### 1. フォントレンダリング ✅ **解決済み**

**課題**: Pure Goでの高品質フォントレンダリング
**解決策**: 
- `golang.org/x/image/font/sfnt`でフォント読み込み
- 基本的なグリフレンダリングの実装
- フォントスタイルの正規化と対応

### 2. パス描画

**課題**: SVGパスの複雑な解析と描画
**解決策**:
- パスフラット化アルゴリズム
- ベジェ曲線の近似
- アンチエイリアシング

### 3. パフォーマンス

**課題**: 大規模SVGの処理速度
**解決策**:
- 並列処理の導入
- 描画領域の最適化
- メモリプールの活用

## 次のステップ

### 即座に取り組むべき項目

1. **パス描画の実装**
   - SVGパスコマンドの解析
   - 基本的なパス描画アルゴリズム

2. **テキスト描画の改善**
   - アンチエイリアシングの実装
   - より精密なフォントメトリクス

3. **変形処理の拡充**
   - transform属性の完全対応
   - 行列演算の最適化

### 中期目標（1-2週間）

1. **パス描画の完成**
2. **テキスト描画の品質向上**
3. **単体テストの充実**

### 長期目標（1ヶ月）

1. **APIの安定化**
2. **パフォーマンス最適化**
3. **包括的なテストスイート**

## 品質基準

- **決定性**: 同一入力→同一出力を保証
- **パフォーマンス**: 1000×1000、1000要素で50ms以内
- **品質**: ブラウザとの差分を許容範囲内に抑制
- **セキュリティ**: 外部リソースの取得を禁止

## テスト戦略

1. **単体テスト**: 各パッケージの機能テスト
2. **統合テスト**: エンドツーエンドの変換テスト
3. **パフォーマンステスト**: 処理時間とメモリ使用量の測定
4. **品質テスト**: 出力画像の品質評価

## 今後の拡張点

1. **追加SVG要素**: `<ellipse>`, `<line>`, `<polygon>`など
2. **アニメーション**: 基本的なアニメーション対応
3. **フィルタ**: 基本的なフィルタ効果
4. **外部CSS**: 外部スタイルシートの読み込み
5. **WebP出力**: より効率的な画像形式への対応

## フォントレンダリングの実装詳細

### 実装された機能

1. **フォント読み込み**
   - SFNT形式（TTF/OTF）のサポート
   - ファイルパスとメモリデータの両方に対応
   - エラーハンドリングとフォールバック

2. **テキストシェイピング**
   - 基本的なグリフ配置
   - フォントサイズとDPIの調整
   - メトリクス情報の取得

3. **テキスト描画**
   - `text-anchor`属性の完全対応
   - フォントスタイル（Bold、Italic）の処理
   - 基本的なグリフレンダリング

4. **システムフォント検出**
   - プラットフォーム別フォントパス
   - 自動スキャンとキャッシュ
   - フォールバックフォントの設定

### 今後の改善点

1. **Harfbuzz統合**
   - より高度なテキストシェイピング
   - 複雑なスクリプトのサポート

2. **アンチエイリアシング**
   - サブピクセルレンダリング
   - フォントヒンティング

3. **フォントキャッシュ**
   - グリフアトラスの実装
   - メモリ使用量の最適化
